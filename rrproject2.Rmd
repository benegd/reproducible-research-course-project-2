---
title: "Storm event types that cause the largest impact"
author: "Benjamin Estrade"
date: "24 July 2018"
output: 
  html_document: 
    keep_md: yes
---

Synopsis
========

Question 1 - Impact on human health
--------------------------------------

* Tornados have the most impact on human health

* Tornados cause the greatest loss of life

* Tornados cause the most injuries

Question 2 - Largest economic cost
----------------------------------

* Floods cause the most economic damage

* Floods cause the most property damage

* Droughts cause the most crop damage

**NOTE.** Figures are shown in the results section. 
All calculations are shown in the data processing section.











Project Goal
============

Use the data to answer some basic questions about severe weather events.

Questions:
1. Across the United States, which types of events (as indicated in the <span style="color:red" face="KaTeX_Typewriter">EVTYPE</span> variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?


Data Processing
===============

Details about project
---------------------

Copy of the data can be found in the [GitHub directory](https://github.com/benegd/reproducible-research-course-project-2).

Data retrived from the [here](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)

This project is part of the data science specialization course by John Hopkins University hosted by [Coursera](https://www.coursera.com/).

Consult README.md for more information


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

System info
-----------

```{r}
sessionInfo()
```

Loading Libraries
-----------------
```{r}
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
library(lubridate)
```



Downloading Data from orginal source
------------------------------------

``` {r}
fileurl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
zippath <- "./ProjectData/Storm_data.csv.bz2"
projectdatapath <- "./ProjectData"
if(!file.exists(zippath)){
        if(!dir.exists(projectdatapath)){
               dir.create(projectdatapath) 
        }
        download.file(fileurl, zippath)
}
rm(fileurl)
```


Loading data into R
-------------------
``` {r cache=TRUE}
stormdata <- read.csv(zippath)
rm(zippath)
head(stormdata)
summary(stormdata)
str(stormdata)
```

Cleaning the data
-----------------

Converting the BGN_DATE to date format

```{r}
stormdata$BGN_DATE <- as.Date(stormdata$BGN_DATE, "%m/%d/%Y")
str(stormdata$BGN_DATE)
```

Data on damage cost is provided as a 3 signifcant figure value and a expander letter 

* K = 1 000

* M = 1 000 000

* B = 1 000 000 000

Converting these values to numeric

```{r}
value_from_expander <- function(data, damage_type){
        damage_type_exp <- paste(damage_type, "EXP", sep="")
        damage_value <- as.numeric(data[damage_type])
        damage_exp <- data[damage_type_exp]
        if(damage_exp == "K"){
                damage_value <- damage_value * 1000
        } else if(damage_exp == "M"){
                damage_value <- damage_value * 1000000
        } else if(damage_exp == "B"){
                damage_value <- damage_value * 1000000000
        }
        damage_value
}
stormdata$Property_damage_USD <- apply(stormdata, 1, value_from_expander, damage_type = "PROPDMG")
stormdata$Crop_damage_USD <- apply(stormdata, 1, value_from_expander, damage_type = "CROPDMG")
stormdata$Total_damage <- stormdata$Property_damage_USD + stormdata$Crop_damage_USD
head(stormdata)
```


Question 1 - Which types of events are most harmful to human health
-----------------------------------------------------------------------

This question could be interepted in several ways, some things to consider

* human health could be considered in the following ways:
        + the most people effected
        + only permant effects considered
        + only direct fatalities considered
        + a different scoring for direct and indirect fatalities/injuries
        +a different scoring for fatalities and injuries
* classification of event type could be considered in the following ways:
        + Event Name
        + Designator
* is there more data available for certain event types and thus could the results be skewed?
* advancements in warning systems may have reduce the damage of particular event types in more recent years, should this be a consideration?
* should the most extreme cases be included or valued the same?
* will the population suffer the same impact from the same event as in previous times

### Assumptions 

* The study doesn't specify if deaths and injury are caused directly or indirectly. For this reason they will be treated of the same value. 

* The event type will grouped by event name

* Since an acurate prediction model for times in between freak event of certain event types isn't available the assumption wil be made the same type and magnitude is as likely to reoccur as any other event type. 

### Have the damage of unusual natural effects changed over time

If there is a correlation between time and the effect in regards to death and injury this should be account for. 

Linear regression will be used, if a p value of less than 0.02 is found then a allowance based on the regression will be used.

This should correlation should include the advancements in any warning systems over time. 

Adding a sum of deaths and injuries to the data. New column will be called FATAL_AND_INJ

````{r}
stormdata <- stormdata %>% mutate(FATAL_AND_INJ = FATALITIES + INJURIES)
head(stormdata[,c("FATALITIES","INJURIES","FATAL_AND_INJ")])
```

Creating a liner regresion model to evaulate the correlation.

Due to the data size and my limited computing power I have had to remove all events that have resulted in no fatalities or injuries for the human health question.


```{r cache=TRUE}
stormdatahealth <- stormdata[stormdata$FATAL_AND_INJ > 0,]
lminjovertime <- lm(FATAL_AND_INJ ~ BGN_DATE, stormdatahealth)
summary(lminjovertime)
```

Time seems to be coralated to the number of deaths and injurys with a reduction in injuries over time. Thus a pentaly should be given based on the the linear regresion. The total fatalities and injuries will be adjusted using the BGN_DATE coefficient from this model and added to a new variable called FAI_TIME_PEN. 

Another adjust has been made so the pental startes at 0 otherwise the earlier values would be negatives.

The coefficent has been reverse to allow add a pentaly to newer events rather than substracting from the older events

Checking there is a significant difference over time.

```{r}
timeco <- -as.numeric(lminjovertime$coefficients[2])
rm(lminjovertime)
rmnegdate <- -as.numeric(min(stormdatahealth$BGN_DATE))
#apply seems to extract each variable as character so the as.Date neeeded to be reapplied, this wouldn't be required otherwise
timeallowfunc <- function(x) {
        if(class(x[["BGN_DATE"]]) != "Date"){
             dateasnum <- as.numeric(as.Date(x["BGN_DATE"]))   
        } else {
                dateasnum <- as.numeric(x["BGN_DATE"])
        }
        
        totalhurt <- as.numeric(x["FATAL_AND_INJ"])
        totalhurt + (dateasnum + rmnegdate) * timeco
}
oldestevent <- stormdatahealth[which.min(stormdatahealth$BGN_DATE),]
newestevent <- stormdatahealth[which.max(stormdatahealth$BGN_DATE),]
timeallowfunc(newestevent) - newestevent["FATAL_AND_INJ"]
timeallowfunc(oldestevent) - oldestevent["FATAL_AND_INJ"]
```

The differnce is substantial enough and thus the allowance will be added. 

```{r}
stormdatahealth$FAI_TIME_PEN <- apply(stormdatahealth, 1, timeallowfunc)
rm(timeallowfunc, oldestevent, newestevent, rmnegdate, timeco)
head(stormdatahealth[,c("FATAL_AND_INJ", "FAI_TIME_PEN")])
tail(stormdatahealth[,c("FATAL_AND_INJ", "FAI_TIME_PEN")])
```

#### Does the pentaly impact the event type with the largest impact?

```{r}
penaltyeval <- stormdatahealth %>% group_by(EVTYPE) %>% summarise(TOTAL = sum(FATAL_AND_INJ), TOTAL_W_PEN = sum(FAI_TIME_PEN))
head(arrange(penaltyeval, desc(TOTAL_W_PEN)))
head(arrange(penaltyeval, desc(TOTAL)))
```

Although the pentaly does have an affect on the order in which the events should be considered to have the largest impact tornado clearly have the largest impact in both occasions.

The impact of the zero measure might have impacted the decline even though this could also skew the results as more events are currently recorded than in previous years. 

```{r}
rm(penaltyeval)
```

### How human health will be considered for this study

The comparing a human life to severe injury is contraversal and in the terms of the data the specific severity of injuries is not defined and the type widely varied so it can't be defined even in a monetary way.

Testing if changed the ratio of value place on death compared to injury affects the most harmful event type. To see if futher research would be worthwhile to give a clearer result. 

Since it is very difficult to define a ratio a broad range from 1:1 to 100:1 will be tested. 

Only the 20 event types with the highest health impact will be reviewed.

```{r}
totalinjsperevent <- stormdatahealth %>% group_by(EVTYPE) %>% summarise(TOTAL_FATAL = sum(FATALITIES), TOTAL_INJ = sum(INJURIES), TOTAL_FAI = sum(FATAL_AND_INJ))
totalinjsperevent <- arrange(totalinjsperevent, desc(TOTAL_FAI))[1:20,]
head(totalinjsperevent)
```

Calculating data required for a normalized plot

```{r}
#creating the x values, which will be the fatality to injury grading ratio
injurygradingratio <- c(1, seq(5,100, by = 5))
#function for calulating the new grade based on the ratio
ratio_calc <- function(event_totals, xvalues){
        total_fatals <- as.numeric(event_totals["TOTAL_FATAL"])
        total_injuries <- as.numeric(event_totals["TOTAL_INJ"])
        total_fatals * xvalues + total_injuries
}
graded_health_scores <- apply(totalinjsperevent, 1, ratio_calc, xvalues = injurygradingratio)
colnames(graded_health_scores) <- totalinjsperevent$EVTYPE
head(graded_health_scores)
```


Melting the data frame in to x y cordinates and normalizing

```{r}
event_type_count <- ncol(graded_health_scores)
graded_health_scores <- melt(graded_health_scores)
graded_health_scores$Var1 <- rep(injurygradingratio, event_type_count)
colnames(graded_health_scores) <- c("ratio", "event_type", "scores")
norm_graded_health_scores <- graded_health_scores %>% group_by(ratio) %>% mutate_at(vars(scores), funs(scale(.) %>% as.vector()) )
head(norm_graded_health_scores)
```

Plotting the effect of the ratio

```{r}
p <- ggplot(norm_graded_health_scores[1:105,], aes(x=ratio, y=scores, colour = event_type, group = event_type))
p <- p + geom_line()
p <- p + geom_point()
p <- p + labs( x = "Ratio")
p <- p + labs(y = "Impact to Human Health Score")
p <- p + ggtitle("Impact of changing the \nfatality:injury ratio")
p
```

From this plot we can see that how we ratio is not important in derterming the event type with the largest impact to human health.

Question 2
----------

###Which type of events have the greatest econmic consquence?

###Considerations

There a few things we might want to considerer when answering this question

* should there be an economic value set for the impacts to human health?

* do we need to account for inflation?

* the data set operates in good faith with cost estimates, with regulation there could be some discreptances

* are there null fields in the data and how should they be handled

```{r}
sapply(stormdata, function(x){length(which(is.na(x)))})
```


*without any NA values it is impossible to tell if zero estimates are accurate or just no information supplied. THis could require further analysis.

* other related costs such as debris clearing, fire fighting and personnel overtime charges are not included in these estimates


### Assumptions 

* The study doesn't specify if deaths and injury are caused directly or indirectly. For this reason they will be treated of the same value. 

* The event type will grouped by event name

* Since an acurate prediction model for times in between freak event of certain event types isn't available the assumption wil be made the same type and magnitude is as likely to reoccur as any other event type. 

* human health will not be considered in this study as it is hard put a price value too and insurficent data is contained in this study

*it would be possible to go through the event naratives to obtain additional costing in regards to more significant figure estimes. Since there isn't a direct sentence structure stimpulated for data entry extraction would be too difficulat and time consuming for this study. Much of this data is likely missing anyway.

*Inflation will not be accounted for in this analysis as fixed values are supplied for damages in the study and as such the damage estimates should not have increased over time for the same items.

### The value of the US currency over time

Chosen to disregaurd inflation as noted above. Data is still included but not currently used. 

Inflation data will be added below and add a copy of the data will be available on the GitHub repository.

This data was downloaded from the Federal Reserve Bank of St. Louis from [this page](https://fred.stlouisfed.org/series/FPCPITOTLZGUSA). 

The data available is from the year 1960 till 2016. Other years will be excluded due to lack of information

### Adding the inflation data


```{r}
fileurl <- "https://fred.stlouisfed.org/graph/fredgraph.csv?chart_type=line&recession_bars=on&log_scales=&bgcolor=%23e1e9f0&graph_bgcolor=%23ffffff&fo=Open+Sans&ts=12&tts=12&txtcolor=%23444444&show_legend=yes&show_axis_titles=yes&drp=0&cosd=1960-01-01&coed=2016-01-01&height=450&stacking=&range=Custom&mode=fred&id=FPCPITOTLZGUSA&transformation=lin&nd=1960-01-01&ost=-99999&oet=99999&lsv=&lev=&mma=0&fml=a&fgst=lin&fgsnd=2009-06-01&fq=Annual&fam=avg&vintage_date=&revision_date=&line_color=%234572a7&line_style=solid&lw=2&scale=left&mark_type=none&mw=2&width=749#"
filepath <- "./ProjectData/inflation.csv"
projectdatapath <- "./ProjectData"
if(!file.exists(filepath)){
        if(!dir.exists(projectdatapath)){
               dir.create(projectdatapath) 
        }
        download.file(fileurl, filepath)
}
rm(fileurl)
```

Add data to r

```{r cache = TRUE}
inflation_data <- read.csv(filepath)
head(inflation_data)
```

### Cleaning the inflation data

```{r}
inflation_data$DATE <- as.Date(inflation_data$DATE)
inflation_data$Year <- lubridate::year(inflation_data$DATE)
colnames(inflation_data) <- c("Date", "Inflation_rate","Year")
head(inflation_data)
```

Extracting the year from the date data in the storm data set

```{r}
stormdata$Year <- lubridate::year(stormdata$BGN_DATE)
head(stormdata[,c("BGN_DATE", "Year")])
```

Calculating the accumlative inflation

```{r}
cumlative_inflation = 0
for(i in 1:nrow(inflation_data)){
        
}
```

###Creating a damage data sumary grouped by event type

```{r}
#Due to an issue with grouping not working I needed to reattach the plyr and dplyr packages
detach(package:plyr)
detach(package:dplyr)
library(plyr)
library(dplyr)
Damages_by_event_type <- group_by(stormdata, EVTYPE)
Damages_by_event_type <- summarize(Damages_by_event_type, Property_damage_USD = sum(Property_damage_USD), Crop_damage_USD = sum(Crop_damage_USD), Total_damage = sum(Total_damage))
Damages_by_event_type <- arrange(Damages_by_event_type, desc(Total_damage))
head(Damages_by_event_type)
```

Reducing this data for plotting results, only the 20 event types with the largest cost will be shown.

```{r}
Reduced_damages_by_event_type <- Damages_by_event_type[1:20,] %>% select(-Total_damage) %>% rename(Event_type = EVTYPE)
Reduced_damages_by_event_type$Event_type <- with(Reduced_damages_by_event_type, factor(Event_type, Event_type))
Reduced_damages_by_event_type <- melt(Reduced_damages_by_event_type, id = "Event_type")
colnames(Reduced_damages_by_event_type) <- c("Event_type", "Damage_type", "Cost_USD")
Reduced_damages_by_event_type$Damage_type <- factor(Reduced_damages_by_event_type$Damage_type, labels = c("Property", "Crops"))
head(Reduced_damages_by_event_type)
```



Results
=======

Question 1 - Which event type had the largest impact to human health?
-----------------------------------------------------------------------

Since putting a higher value on fatalities compared to injuries didn't affect the outcome of the event type with the largest impact. Nor did calculation of a reducition in impact to human health in modern times. The output plot will simply contain some of the highest damage event types with the quanities of injuries and deaths.


```{r}
totals <- totalinjsperevent %>% arrange(desc(TOTAL_FAI)) %>% select(-TOTAL_FAI)
totals <- melt(totals, id.vars = "EVTYPE", measure.vars = c("TOTAL_FATAL", "TOTAL_INJ"))
colnames(totals) <- c("event", "injury_type","no_of_injuries")
totals$injury_type <- revalue(totals$injury_type, c( "TOTAL_INJ" = "Injuries", "TOTAL_FATAL" = "Fatalities"))
totals$event <- factor(totals$event, levels = totalinjsperevent$EVTYPE)
totals$injury_type <- factor(totals$injury_type, c("Injuries", "Fatalities"))
p <- ggplot(totals, aes(x=event, y=no_of_injuries, fill = injury_type))
p <- p + geom_bar(stat = "identity")
p <- p + scale_fill_manual(values=c("rosybrown", "red3"))
p <- p + guides(fill = guide_legend(reverse = FALSE, title = "Type of Injury"))
p <- p + labs( x = "Event Type")
p <- p + labs(y = "No. of people impacted")
p <- p + ggtitle("Impact of different events to human health")
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
p
```


It is clear that Tornados are the event type that has the greatest impact to human health. In both injurys and fatalities it is clearly the highest. 

Question 2 - Across the United States, which types of events have the greatest economic consequences?
---------------------------------------------------------------------------------------------------------



```{r}
p <- ggplot(Reduced_damages_by_event_type, aes(x=Event_type, y=Cost_USD, fill = Damage_type))
p <- p + geom_bar(stat = "identity")
p <- p + scale_fill_manual(values=c("rosybrown", "red3"))
p <- p + guides(fill = guide_legend(reverse = FALSE, title = "Type of Damage"))
p <- p + labs( x = "Event Type")
p <- p + labs(y = "Cost in Billions of USD")
p <- p + scale_y_continuous(labels = c("0","50","100","150"))
p <- p + ggtitle("Economic damage of different event types")
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
p
```

It is clear that floods are the event type that cause the most economical damage.

It is also clear that droughts cause the largest amount of crop damage.

### Reviewing the Economic Value of a life

Looking at the economic value a life would need to have for Tornado to become the highest damage.

```{r}
Flood_damage_cost <- Damages_by_event_type %>% filter(EVTYPE == "FLOOD") %>% select(Total_damage)
Tornado_damage_cost <- Damages_by_event_type %>% filter(EVTYPE == "TORNADO") %>% select(Total_damage)
Flood_fatalities <- totalinjsperevent %>% filter(EVTYPE == "FLOOD") %>% select(TOTAL_FATAL)
Tornado_fatalities <- totalinjsperevent %>% filter(EVTYPE == "TORNADO") %>% select(TOTAL_FATAL)
cost_per_life <- (Tornado_damage_cost - Flood_damage_cost)/(Flood_fatalities - Tornado_fatalities)
cost_per_life
```

I human life would need to have an economic value of over 18 Million before tornados caused the highest economical damage.






