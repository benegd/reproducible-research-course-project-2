---
title: "Storm event types that cause the largest impact"
author: "Benjamin Estrade"
date: "24 July 2018"
output: 
  html_document: 
    keep_md: yes
---

Synopsis
========














Project Goal
============

Use the data to answer some basic questions about severe weather events.

Questions:
1. Across the United States, which types of events (as indicated in the <span style="color:red" face="KaTeX_Typewriter">EVTYPE</span> variable) are most harmful with respect to population health?

2. Across the United States, which types of events have the greatest economic consequences?


Data Processing
===============

Details about project
---------------------

Copy of the data can be found in the [GitHub directory](https://github.com/benegd/reproducible-research-course-project-2).

Data retrived from the [here](https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2)

This project is part of the data science specialization course by John Hopkins University hosted by [Coursera](https://www.coursera.com/).

Consult README.md for more information


```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

System info
-----------

```{r}
sessionInfo()
```

Loading Libraries
-----------------
```{r}
library(plyr)
library(dplyr)
library(reshape2)
library(ggplot2)
```



Downloading Data from orginal source
------------------------------------

``` {r}
fileurl <- "https://d396qusza40orc.cloudfront.net/repdata%2Fdata%2FStormData.csv.bz2"
zippath <- "./ProjectData/Storm_data.csv.bz2"
projectdatapath <- "./ProjectData"
if(!file.exists(zippath)){
        if(!dir.exists(projectdatapath)){
               dir.create(projectdatapath) 
        }
        download.file(fileurl, zippath)
}
rm(fileurl)
```


Loading data into R
-------------------
``` {r cache=TRUE}
stormdata <- read.csv(zippath)
rm(zippath)
head(stormdata)
summary(stormdata)
str(stormdata)
```

Cleaning the data
-----------------

Converting the BGN_DATE to date format

```{r}
stormdata$BGN_DATE <- as.Date(stormdata$BGN_DATE, "%m/%d/%Y")
str(stormdata$BGN_DATE)
```


Question 1 - Which types of events are most harmful to human health
-----------------------------------------------------------------------

This question could be interepted in several ways, some things to consider

* human health could be considered in the following ways:
        + the most people effected
        + only permant effects considered
        + only direct fatalities considered
        + a different scoring for direct and indirect fatalities/injuries
        +a different scoring for fatalities and injuries
* classification of event type could be considered in the following ways:
        + Event Name
        + Designator
* is there more data available for certain event types and thus could the results be skewed?
* advancements in warning systems may have reduce the damage of particular event types in more recent years, should this be a consideration?
* should the most extreme cases be included or valued the same?
* will the population suffer the same impact from the same event as in previous times

### Assumptions 

* The study doesn't specify if deaths and injury are caused directly or indirectly. For this reason they will be treated of the same value. 

* The event type will grouped by event name

* Since an acurate prediction model for times in between freak event of certain event types isn't available the assumption wil be made the same type and magnitude is as likely to reoccur as any other event type. 

### Have the damage of unusual natural effects changed over time

If there is a correlation between time and the effect in regards to death and injury this should be account for. 

Linear regression will be used, if a p value of less than 0.02 is found then a allowance based on the regression will be used.

This should correlation should include the advancements in any warning systems over time. 

Adding a sum of deaths and injuries to the data. New column will be called FATAL_AND_INJ

````{r}
stormdata <- stormdata %>% mutate(FATAL_AND_INJ = FATALITIES + INJURIES)
head(stormdata[,c("FATALITIES","INJURIES","FATAL_AND_INJ")])
```

Creating a liner regresion model to evaulate the correlation.

Due to the data size and my limited computing power I have had to remove all events that have resulted in no fatalities or injuries for the human health question.


```{r cache=TRUE}
stormdatahealth <- stormdata[stormdata$FATAL_AND_INJ > 0,]
lminjovertime <- lm(FATAL_AND_INJ ~ BGN_DATE, stormdatahealth)
summary(lminjovertime)
```

Time seems to be coralated to the number of deaths and injurys with a reduction in injuries over time. Thus a pentaly should be given based on the the linear regresion. The total fatalities and injuries will be adjusted using the BGN_DATE coefficient from this model and added to a new variable called FAI_TIME_PEN. 

Another adjust has been made so the pental startes at 0 otherwise the earlier values would be negatives.

The coefficent has been reverse to allow add a pentaly to newer events rather than substracting from the older events

Checking there is a significant difference over time.

```{r}
timeco <- -as.numeric(lminjovertime$coefficients[2])
rm(lminjovertime)
rmnegdate <- -as.numeric(min(stormdatahealth$BGN_DATE))
#apply seems to extract each variable as character so the as.Date neeeded to be reapplied, this wouldn't be required otherwise
timeallowfunc <- function(x) {
        if(class(x[["BGN_DATE"]]) != "Date"){
             dateasnum <- as.numeric(as.Date(x["BGN_DATE"]))   
        } else {
                dateasnum <- as.numeric(x["BGN_DATE"])
        }
        
        totalhurt <- as.numeric(x["FATAL_AND_INJ"])
        totalhurt + (dateasnum + rmnegdate) * timeco
}
oldestevent <- stormdatahealth[which.min(stormdatahealth$BGN_DATE),]
newestevent <- stormdatahealth[which.max(stormdatahealth$BGN_DATE),]
timeallowfunc(newestevent) - newestevent["FATAL_AND_INJ"]
timeallowfunc(oldestevent) - oldestevent["FATAL_AND_INJ"]
```

The differnce is substantial enough and thus the allowance will be added. 

```{r}
stormdatahealth$FAI_TIME_PEN <- apply(stormdatahealth, 1, timeallowfunc)
rm(timeallowfunc, oldestevent, newestevent, rmnegdate, timeco)
head(stormdatahealth[,c("FATAL_AND_INJ", "FAI_TIME_PEN")])
tail(stormdatahealth[,c("FATAL_AND_INJ", "FAI_TIME_PEN")])
```

#### Does the pentaly impact the event type with the largest impact?

```{r}
penaltyeval <- stormdatahealth %>% group_by(EVTYPE) %>% summarise(TOTAL = sum(FATAL_AND_INJ), TOTAL_W_PEN = sum(FAI_TIME_PEN))
head(arrange(penaltyeval, desc(TOTAL_W_PEN)))
head(arrange(penaltyeval, desc(TOTAL)))
```

Although the pentaly does have an affect on the order in which the events should be considered to have the largest impact tornado clearly have the largest impact in both occasions.

The impact of the zero measure might have impacted the decline even though this could also skew the results as more events are currently recorded than in previous years. 

```{r}
rm(penaltyeval)
```

### How human health will be considered for this study

The comparing a human life to severe injury is contraversal and in the terms of the data the specific severity of injuries is not defined and the type widely varied so it can't be defined even in a monetary way.

Testing if changed the ratio of value place on death compared to injury affects the most harmful event type. To see if futher research would be worthwhile to give a clearer result. 

Since it is very difficult to define a ratio a broad range from 1:1 to 100:1 will be tested. 

Only the 20 event types with the highest health impact will be reviewed.

```{r}
totalinjsperevent <- stormdatahealth %>% group_by(EVTYPE) %>% summarise(TOTAL_FATAL = sum(FATALITIES), TOTAL_INJ = sum(INJURIES), TOTAL_FAI = sum(FATAL_AND_INJ))
totalinjsperevent <- arrange(totalinjsperevent, desc(TOTAL_FAI))[1:20,]
head(totalinjsperevent)
```

Calculating data required for a normalized plot

```{r}
#creating the x values, which will be the fatality to injury grading ratio
injurygradingratio <- c(1, seq(5,100, by = 5))
#function for calulating the new grade based on the ratio
ratio_calc <- function(event_totals, xvalues){
        total_fatals <- as.numeric(event_totals["TOTAL_FATAL"])
        total_injuries <- as.numeric(event_totals["TOTAL_INJ"])
        total_fatals * xvalues + total_injuries
}
graded_health_scores <- apply(totalinjsperevent, 1, ratio_calc, xvalues = injurygradingratio)
colnames(graded_health_scores) <- totalinjsperevent$EVTYPE
head(graded_health_scores)
```


Melting the data frame in to x y cordinates and normalizing

```{r}
event_type_count <- ncol(graded_health_scores)
graded_health_scores <- melt(graded_health_scores)
graded_health_scores$Var1 <- rep(injurygradingratio, event_type_count)
colnames(graded_health_scores) <- c("ratio", "event_type", "scores")
norm_graded_health_scores <- graded_health_scores %>% group_by(ratio) %>% mutate_at(vars(scores), funs(scale(.) %>% as.vector()) )
head(norm_graded_health_scores)
```

Plotting the effect of the ratio

```{r}
p <- ggplot(norm_graded_health_scores[1:105,], aes(x=ratio, y=scores, colour = event_type, group = event_type))
p <- p + geom_line()
p <- p + geom_point()
p <- p + labs( x = "Ratio")
p <- p + labs(y = "Impact to Human Health Score")
p <- p + ggtitle("Impact of changing the \nfatality:injury ratio")
p
```

From this plot we can see that how we ratio is not important in derterming the event type with the largest impact to human health.

### Output plot

Since putting a higher value on fatalities compared to injuries did affect the outcome of the event type with the largest impact. Nor did calculation of reducition indamage to human health in modern times. The output plot will simply contain some of the highest damage event types with the quanities of injuries and deaths.

I will use the previously generated totals dataset.

```{r}
totals <- totalinjsperevent %>% arrange(desc(TOTAL_FAI)) %>% select(-TOTAL_FAI)
totals <- melt(totals, id.vars = "EVTYPE", measure.vars = c("TOTAL_FATAL", "TOTAL_INJ"))
colnames(totals) <- c("event", "injury_type","no_of_injuries")
totals$injury_type <- revalue(totals$injury_type, c( "TOTAL_INJ" = "Injuries", "TOTAL_FATAL" = "Fatalities"))
totals$event <- factor(totals$event, levels = totalinjsperevent$EVTYPE)
totals$injury_type <- factor(totals$injury_type, c("Injuries", "Fatalities"))
p <- ggplot(totals, aes(x=event, y=no_of_injuries, fill = injury_type))
p <- p + geom_bar(stat = "identity")
p <- p + scale_fill_manual(values=c("rosybrown", "red3"))
p <- p + guides(fill = guide_legend(reverse = FALSE, title = "Type of Injury"))
p <- p + labs( x = "Event Type")
p <- p + labs(y = "No. of people impacted")
p <- p + ggtitle("Impact of different events to human health")
p <- p + theme(axis.text.x = element_text(angle = 90, hjust = 1, vjust = 0.5))
p
```

Results
=======












